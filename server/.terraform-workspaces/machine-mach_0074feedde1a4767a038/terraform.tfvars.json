{
  "do_token": "dop_v1_c2292e0c51bd77ed56a57305cc0406b0b3dfecf1c094df9a8d00b0b997cac3a9",
  "name": "ma",
  "region": "sfo3",
  "size": "s-1vcpu-1gb",
  "image": "ubuntu-22-04-x64",
  "tags": [],
  "user_data": "#cloud-config\npackage_update: true\npackage_upgrade: true\n\npackages:\n  - curl\n  - git\n  - build-essential\n  - unzip\n  - nginx\n\nusers:\n  - name: machine\n    groups: sudo\n    shell: /bin/bash\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    home: /home/machine\n\nwrite_files:\n  - path: /etc/systemd/system/machine-dashboard.service\n    content: |\n      [Unit]\n      Description=Machine Dashboard API\n      After=network.target\n      \n      [Service]\n      Type=simple\n      User=machine\n      WorkingDirectory=/home/machine/machine\n      Environment=NODE_ENV=production\n      Environment=PORT=3001\n      Environment=PUBLIC_SERVER_URL=http://{{PUBLIC_IP}}:3001\n      Environment=CORS_ORIGIN=*\n      ExecStart=/usr/bin/node server/dist/index.js\n      Restart=always\n      RestartSec=10\n      \n      [Install]\n      WantedBy=multi-user.target\n    permissions: '0644'\n\n  - path: /etc/nginx/sites-available/machine\n    content: |\n      server {\n          listen 80;\n          server_name _;\n          \n          # Serve frontend static files\n          location / {\n              root /home/machine/machine/client/dist;\n              try_files $uri $uri/ /index.html;\n          }\n          \n          # Proxy API requests to backend\n          location /api {\n              proxy_pass http://127.0.0.1:3001;\n              proxy_http_version 1.1;\n              proxy_set_header Upgrade $http_upgrade;\n              proxy_set_header Connection 'upgrade';\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n              proxy_cache_bypass $http_upgrade;\n              \n              # SSE support\n              proxy_buffering off;\n              proxy_read_timeout 86400;\n          }\n          \n          # Health check\n          location /health {\n              proxy_pass http://127.0.0.1:3001/health;\n          }\n      }\n    permissions: '0644'\n\n  - path: /home/machine/setup-machine.sh\n    content: |\n      #!/bin/bash\n      set -e\n      exec > >(tee /var/log/machine-setup.log) 2>&1\n      \n      echo \"=== $(date) - Starting Machine Dashboard Setup ===\"\n      \n      # Install Node.js 20\n      echo \"=== Installing Node.js 20 ===\"\n      curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -\n      sudo apt-get install -y nodejs\n      node --version\n      npm --version\n      \n      # Install Terraform\n      echo \"=== Installing Terraform ===\"\n      curl -fsSL https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip -o /tmp/terraform.zip\n      sudo unzip -o /tmp/terraform.zip -d /usr/local/bin/\n      rm /tmp/terraform.zip\n      terraform --version\n      \n      # Clone Machine repository\n      echo \"=== Cloning Machine repository ===\"\n      if [ -d \"/home/machine/machine\" ]; then\n        echo \"Directory exists, pulling latest...\"\n        cd /home/machine/machine\n        git pull\n      else\n        git clone https://github.com/cypher-agi/machine.git /home/machine/machine\n        cd /home/machine/machine\n      fi\n      \n      # Install dependencies\n      echo \"=== Installing npm dependencies ===\"\n      npm ci\n      \n      # Build the application\n      echo \"=== Building application ===\"\n      npm run build\n      \n      # Get public IP for service config\n      echo \"=== Configuring service ===\"\n      PUBLIC_IP=$(curl -s ifconfig.me)\n      echo \"Public IP: $PUBLIC_IP\"\n      \n      # Update systemd service with actual IP\n      sudo sed -i \"s/{{PUBLIC_IP}}/$PUBLIC_IP/g\" /etc/systemd/system/machine-dashboard.service\n      \n      echo \"=== $(date) - Machine Dashboard Setup Complete ===\"\n    permissions: '0755'\n\nruncmd:\n  # Create machine user home\n  - mkdir -p /home/machine\n  - chown -R machine:machine /home/machine\n  \n  # Run setup as machine user\n  - chown machine:machine /home/machine/setup-machine.sh\n  - su - machine -c '/home/machine/setup-machine.sh'\n  \n  # Setup nginx\n  - rm -f /etc/nginx/sites-enabled/default\n  - ln -sf /etc/nginx/sites-available/machine /etc/nginx/sites-enabled/machine\n  - nginx -t && systemctl restart nginx\n  \n  # Start the dashboard service\n  - systemctl daemon-reload\n  - systemctl enable machine-dashboard.service\n  - systemctl start machine-dashboard.service\n  \n  # Log completion\n  - echo \"Machine Dashboard deployed at $(date)\" | tee -a /var/log/machine-bootstrap.log\n  - echo \"Access at http://$(curl -s ifconfig.me)\" | tee -a /var/log/machine-bootstrap.log"
}