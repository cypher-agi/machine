{
  "do_token": "dop_v1_c2292e0c51bd77ed56a57305cc0406b0b3dfecf1c094df9a8d00b0b997cac3a9",
  "name": "d",
  "region": "sfo3",
  "size": "s-1vcpu-1gb",
  "image": "ubuntu-22-04-x64",
  "tags": [],
  "user_data": "#cloud-config\npackage_update: true\npackage_upgrade: true\n\npackages:\n  - build-essential\n  - pkg-config\n  - libssl-dev\n  - libclang-dev\n  - cmake\n  - git\n  - curl\n\nusers:\n  - name: grid\n    groups: sudo\n    shell: /bin/bash\n    sudo: ALL=(ALL) NOPASSWD:ALL\n    home: /home/grid\n\nwrite_files:\n  - path: /etc/systemd/system/the-grid.service\n    content: |\n      [Unit]\n      Description=The Grid Node\n      After=network.target\n      \n      [Service]\n      Type=simple\n      User=grid\n      WorkingDirectory=/home/grid/the-grid\n      Environment=RUST_LOG=info\n      Environment=GRID_BIND_ADDR=0.0.0.0:36900\n      ExecStart=/home/grid/the-grid/target/release/the-grid\n      Restart=always\n      RestartSec=10\n      \n      [Install]\n      WantedBy=multi-user.target\n    permissions: '0644'\n\n  - path: /etc/systemd/system/machine-agent.service\n    content: |\n      [Unit]\n      Description=Machine Agent - sends heartbeat to dashboard\n      After=network-online.target\n      Wants=network-online.target\n      \n      [Service]\n      Type=simple\n      ExecStart=/opt/machine-agent/agent.sh\n      Restart=always\n      RestartSec=30\n      \n      [Install]\n      WantedBy=multi-user.target\n    permissions: '0644'\n\n  - path: /opt/machine-agent/agent.sh\n    content: |\n      #!/bin/bash\n      # Machine Agent - Simple heartbeat sender\n      \n      # Configuration (set by cloud-init)\n      MACHINE_ID=\"mach_274b2ec165394eb6b5a0\"\n      SERVER_URL=\"http://localhost:3001\"\n      AGENT_VERSION=\"1.0.0\"\n      \n      # Wait for network\n      sleep 10\n      \n      while true; do\n        # Get system info\n        HOSTNAME=$(hostname)\n        UPTIME=$(cat /proc/uptime | cut -d' ' -f1 | cut -d'.' -f1)\n        LOAD=$(cat /proc/loadavg | cut -d' ' -f1-3 | tr ' ' ',')\n        \n        # Memory info (in MB)\n        MEM_TOTAL=$(free -m | awk '/^Mem:/{print $2}')\n        MEM_USED=$(free -m | awk '/^Mem:/{print $3}')\n        \n        # Disk info (in GB)\n        DISK_TOTAL=$(df -BG / | awk 'NR==2{print $2}' | tr -d 'G')\n        DISK_USED=$(df -BG / | awk 'NR==2{print $3}' | tr -d 'G')\n        \n        # Get public IP\n        PUBLIC_IP=$(curl -s --max-time 5 ifconfig.me || echo \"\")\n        \n        # Build JSON payload\n        PAYLOAD=$(cat <<EOF\n      {\n        \"machine_id\": \"$MACHINE_ID\",\n        \"agent_version\": \"$AGENT_VERSION\",\n        \"hostname\": \"$HOSTNAME\",\n        \"uptime_seconds\": $UPTIME,\n        \"load_average\": [$LOAD],\n        \"memory_total_mb\": $MEM_TOTAL,\n        \"memory_used_mb\": $MEM_USED,\n        \"disk_total_gb\": $DISK_TOTAL,\n        \"disk_used_gb\": $DISK_USED,\n        \"public_ip\": \"$PUBLIC_IP\"\n      }\n      EOF\n      )\n        \n        # Send heartbeat\n        curl -s -X POST \"$SERVER_URL/api/agent/heartbeat\"           -H \"Content-Type: application/json\"           -d \"$PAYLOAD\" > /dev/null 2>&1\n        \n        # Sleep 30 seconds\n        sleep 30\n      done\n    permissions: '0755'\n\n  - path: /home/grid/setup-grid.sh\n    content: |\n      #!/bin/bash\n      set -e\n      exec > >(tee /var/log/grid-setup.log) 2>&1\n      \n      echo \"=== $(date) - Starting Grid Setup ===\"\n      \n      # Install Rust\n      echo \"=== Installing Rust and Cargo ===\"\n      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y\n      \n      # Source cargo environment\n      export CARGO_HOME=\"$HOME/.cargo\"\n      export RUSTUP_HOME=\"$HOME/.rustup\"\n      export PATH=\"$CARGO_HOME/bin:$PATH\"\n      source \"$HOME/.cargo/env\"\n      \n      # Verify cargo is installed\n      echo \"=== Verifying Cargo installation ===\"\n      which cargo\n      cargo --version\n      rustc --version\n      \n      # Clone the repository\n      echo \"=== Cloning the-grid repository ===\"\n      if [ -d \"/home/grid/the-grid\" ]; then\n        echo \"Directory exists, pulling latest...\"\n        cd /home/grid/the-grid\n        git pull\n      else\n        git clone https://github.com/cypher-agi/the-grid.git /home/grid/the-grid\n        cd /home/grid/the-grid\n      fi\n      \n      # Fetch all dependencies first\n      echo \"=== Fetching Cargo dependencies ===\"\n      cargo fetch\n      \n      # Build in release mode\n      echo \"=== Building the-grid (release mode) ===\"\n      cargo build --release\n      \n      # Verify binary exists\n      echo \"=== Verifying build ===\"\n      if [ -f \"target/release/the-grid\" ]; then\n        echo \"SUCCESS: Binary built at target/release/the-grid\"\n        ls -la target/release/the-grid\n      else\n        echo \"ERROR: Binary not found!\"\n        ls -la target/release/ || true\n        exit 1\n      fi\n      \n      echo \"=== $(date) - Grid Setup Complete ===\"\n    permissions: '0755'\n\nruncmd:\n  # Ensure grid user owns their home directory\n  - mkdir -p /home/grid\n  - chown -R grid:grid /home/grid\n  \n  # Setup machine agent directory\n  - mkdir -p /opt/machine-agent\n  - chmod 755 /opt/machine-agent/agent.sh\n  \n  # Run setup as grid user\n  - chown grid:grid /home/grid/setup-grid.sh\n  - su - grid -c '/home/grid/setup-grid.sh'\n  \n  # Verify binary was built before starting service\n  - |\n    if [ -f \"/home/grid/the-grid/target/release/the-grid\" ]; then\n      echo \"Binary found, starting service...\"\n      systemctl daemon-reload\n      systemctl enable the-grid.service\n      systemctl start the-grid.service\n      echo \"The Grid service started successfully\" | tee -a /var/log/grid-bootstrap.log\n    else\n      echo \"ERROR: Binary not found, service not started\" | tee -a /var/log/grid-bootstrap.log\n      exit 1\n    fi\n  \n  # Start machine agent\n  - systemctl daemon-reload\n  - systemctl enable machine-agent.service\n  - systemctl start machine-agent.service\n  - echo \"Machine agent started\" | tee -a /var/log/grid-bootstrap.log\n  \n  # Log completion\n  - echo \"The Grid bootstrap complete at $(date)\" | tee -a /var/log/grid-bootstrap.log"
}